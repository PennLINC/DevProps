---
title: "Group_level"
output: html_document
---

```{r}
library(ggplot2)
library(mgcv)
```

```{r}
# load in subj list
subjList=read.delim('Y:/PWs/hcpd_subj_list.txt')

# load in ages
demo=read.csv('Y:/PWs/hcpd_demographics.csv')
# convert to used naming convention
demo$SubjID<-gsub('HCD','sub-',demo$src_subject_id)

# load in FD
FD_TRs=read.csv('Y:/PWs/Subj_FD_RemTRs.csv')
colnames(FD_TRs)[1]<-'SubjID'
colnames(FD_TRs)[2]<-'FD'
colnames(FD_TRs)[3]<-'RemainingTRs'

# merge by subjID
mergeddf<-merge(demo,FD_TRs,by='SubjID')

# initialize D
Ds=rep(0,dim(subjList)[1])
Ps=rep(0,dim(subjList)[1])
remTRs=rep(0,dim(subjList)[1])

# subjvec to run in parallel for even more confidence in merging
Subjvec=rep(0,dim(subjList)[1])

# initialize shape matrix
shapeMat=array(dim=c(24,2,dim(subjList)[1]))
shapeMatAbs=array(dim=c(24,2,dim(subjList)[1]))

# load in D iteratively
for (s in 1:dim(subjList)[1]){
    subj=subjList[s,1]
    ResFp=paste0('Y:/results/PWs/Proced/',subj,'/')
    # if output exists
    if (file.exists(paste0(ResFp,subj,'_gShapeMatrix.rds'))) {
      # load in dip test
      dipstat=readRDS(paste0(ResFp,subj,'_gDipTest.rds'))
      Ds[s]=dipstat$statistic
      Ps[s]=dipstat$p.value
      # and to record same order of subj loading and prevent funny biz
      Subjvec[s]=subj
      print(s)
      # and remaining TRs
      remTRs[s]=mergeddf$RemainingTRs[mergeddf$SubjID==subj]
    }
}

# merge populated vecs
popDf=data.frame(Subjvec,Ds,Ps,remTRs)
colnames(popDf)[1]<-'SubjID'

# remaining TRs thresh
inclusionVec<-popDf$remTRs>600
includedSubjsvec<-popDf$SubjID[inclusionVec]
popDfThresh=popDf[popDf$remTRs>600,]
ThreshShapeMat<-shapeMat[,,inclusionVec]

masterdf=merge(mergeddf,popDfThresh,by='SubjID')

# load in dmn seg
DMNseg=read.csv('Y:/results/DMNseg.csv')
colnames(DMNseg)<-c('SubjID','DMNseg','DMNsegGro')
masterdf<-merge(masterdf,DMNseg,by='SubjID')
```

```{r}
# mode mode distributions
PGGmodeL=read.csv('Y:/results/PWs/ModeModes4_L.csv')
PGGmodeR=read.csv('Y:/results/PWs/ModeModes4_R.csv')
CGmodeL=read.csv('Y:/results/PWs/curvModeModes4_L.csv')
CGmodeR=read.csv('Y:/results/PWs/curvModeModes4_R.csv')
hist(c(PGGmodeL$OutArray_L,PGGmodeR$OutArray_R))
hist(c(CGmodeL$OutArray_L,CGmodeR$OutArray_R))

# mean mean distributions
meanMeans=read.csv('Y:/results/MeanSDs_MeanRelativeAngle_PGG.csv')
PGGmeanL=unlist(meanMeans[1:4589])
PGGmeanR=unlist(meanMeans[4590:9185])

# convert range of -pi to pi to 0:180
PGGmeanL=abs(PGGmeanL)*(180/pi)
PGGmeanR=abs(PGGmeanR)*(180/pi)

```


```{r}
####### This chunk is just for saving out subject lists corresponding to age tertiles for the cluster

# make list of old subjs vs younger
low_tertile_age=quantile(masterdf$interview_age,.33)
high_tertile_age=quantile(masterdf$interview_age,.66)

# youngins
youngins=masterdf$SubjID[masterdf$interview_age<low_tertile_age]
write.table(youngins,'Y:/PWs/young_subs.csv')
#geezers
geezers=masterdf$SubjID[masterdf$interview_age>high_tertile_age]
write.table(geezers,'Y:/PWs/old_subs.csv')



##### make subject lists for RS w/ good _carit task runs ( > 300 TRs retained)

###### 388
rs_subs<-masterdf$SubjID
#print
write.table(rs_subs,'Y:/PWs/rs_subs.csv')

#### RS_C matched: rope in a bunch of goblyguk just for equivalence with facewise_t
# load in FD
FD_TRs=read.csv('Y:/PWs/Subj_FD_RemTRs.csv')
colnames(FD_TRs)[1]<-'SubjID'
colnames(FD_TRs)[2]<-'FD'
colnames(FD_TRs)[3]<-'RemainingTRs'
# FD for carit runs
FD_TRs_c=read.csv('Y:/PWs/Subj_FD_RemTRs_c.csv')
colnames(FD_TRs_c)[1]<-'SubjID'
colnames(FD_TRs_c)[2]<-'FDc'
colnames(FD_TRs_c)[3]<-'RemainingTRsc'
# merge by subjID
mergeddf<-merge(demo,FD_TRs,by='SubjID')
mergeddf<-merge(mergeddf,FD_TRs_c,by='SubjID')
# exclude subjects with less than 600 TRs remaining (in rest)
inclusionVec<-mergeddf$RemainingTRs>600
# include NAs in the exclusion
inclusionVec[is.na(inclusionVec)==TRUE]=FALSE
# subset the master df accordingly
mergeddf<-mergeddf[inclusionVec,]
# get count of remaining subjects
remainingSubjs=dim(mergeddf)[1]
print(remainingSubjs)
# exclude subjects with less than 300 TRs remaining (in carit)
inclusionVec<-mergeddf$RemainingTRsc>300
# include NAs in the exclusion
inclusionVec[is.na(inclusionVec)==TRUE]=FALSE
# subset the master df accordingly
df<-mergeddf[inclusionVec,]
# get count of remaining subjects
remainingSubjs=dim(df)[1]
print(remainingSubjs)
# extract subjs
rs_cmatch_subjs<-df$SubjID
# print
write.table(rs_cmatch_subjs,'Y:/PWs/rs_cmatch_subs.csv')

# _C: will need FP alteration in .m, but is from same subjects
```

```{r}
# read in discretized cross subj histograms (linear)
o_disthist<-t(read.csv('Y:/results/PWs/old_subs_AngDistHist.csv'))
y_disthist<-t(read.csv('Y:/results/PWs/young_subs_AngDistHist.csv'))

# normalize to total numbers
o_disthist<-o_disthist/sum(o_disthist)
y_disthist<-y_disthist/sum(y_disthist)

difHist=o_disthist-y_disthist

# boring plots
#barplot(t(o_disthist),ylim=c(0,0.07),main = 'Old r.s. OpFl Directionality',xlab='0-180')
#barplot(t(y_disthist),ylim=c(0,0.07),main = 'Young OpFl Directionality',xlab='0-180')
#barplot(t(difHist),main='Difference in OpFl Directionality',xlab='0-180')

# fancy plots
#### young fancy
plotdatafy<-data.frame(seq(1,18),y_disthist)
# correct to be degrees rather than histogram bin index
plotdatafy$seq.1..18.<-plotdatafy$seq.1..18.*10

p<-ggplot(plotdatafy,aes(x=seq.1..18.,y=y_disthist*100))
p+geom_bar(stat='identity',color='black',aes(fill= ..x..),binwidth = 10)+xlab("Distance (Degrees)")+theme_classic(base_size = 26)+scale_x_continuous(limits=(c(0,190)))+scale_fill_gradientn("value",colors=c("blue","cyan","green","yellow","orange","red"))+ggtitle(paste0('\u2207PG Distance: 8-14'))+theme(plot.title= element_text(size=30, face="bold"), axis.title = element_text(size=30, face="bold",vjust=-1),axis.text = element_text(face="bold",size=30),legend.title=element_blank(),legend.text=element_text(size=20),legend.position=c(1.07,.41),plot.margin=margin(b=.1,t=.1,l=.1,r=2.1, unit='cm'))+ylab('count')+ylab('% of Propagations')
# saved out at 650x650


#### old fancy
plotdatafo<-data.frame(seq(1,18),o_disthist)
# correct to be degrees rather than histogram bin index
plotdatafo$seq.1..18.<-plotdatafo$seq.1..18.*10

p<-ggplot(plotdatafo,aes(x=seq.1..18.,y=o_disthist*100))
p+geom_bar(stat='identity',color='black',aes(fill= ..x..),binwidth = 10)+xlab("Distance (Degrees)")+theme_classic(base_size = 26)+scale_x_continuous(limits=(c(0,190)))+scale_fill_gradientn("value",colors=c("blue","cyan","green","yellow","orange","red"))+ggtitle(paste0('\u2207PG Distance: 17-21'))+theme(plot.title= element_text(size=30, face="bold"), axis.title = element_text(size=30, face="bold",vjust=-1),axis.text = element_text(face="bold",size=30),legend.title=element_blank(),legend.text=element_text(size=20),legend.position=c(1.07,.41),plot.margin=margin(b=.1,t=.1,l=.1,r=2.1, unit='cm'))+ylab('count')+ylab('% of Propagations')

# saved out at 650x650

#difference fancy

plotdataf<-data.frame(seq(1,18),o_disthist-y_disthist)
# correct to be degrees rather than histogram bin index
plotdataf$seq.1..18.<-plotdataf$seq.1..18.*10

p<-ggplot(plotdataf,aes(x=seq.1..18.,y=o_disthist...y_disthist))
p+geom_bar(stat='identity',color='black',aes(fill= ..x..),binwidth = 10)+xlab("Distance (Degrees)")+theme_classic(base_size = 23)+scale_x_continuous(limits=(c(0,190)))+scale_fill_gradientn("value",colors=c("blue","cyan","green","yellow","orange","red"))+ggtitle("Angular Distance over all TRs: Dif")+theme(plot.title= element_text(size=30, face="bold"), axis.title = element_text(size=30, face="bold"),axis.text = element_text(face="bold",size=30),legend.title=element_blank(),legend.text=element_text(size=20),legend.position=c(1.07,.41),plot.margin=margin(b=.1,t=.1,l=.1,r=2.3, unit='cm'))+ylab('count')


# load in permuted old young dif
PermDif=read.csv('Y:/results/PWs/Old_v_young_AngDistDif_permuted.csv')
permDf<-data.frame(PermDif)

# make vectors of mean values of permuted at each bin
meanVec=colMeans(permDf[1:1000,])
# make vectors of 95 and 5th percentile of permuted at each bin
topPercVec=unlist(lapply(permDf[1:1000,1:18],quantile,prob=.95,names=F))
botPercVec=unlist(lapply(permDf[1:1000,1:18],quantile,prob=.05,names=F))

plotdataf$meanVec=meanVec
plotdataf$topPercVec=topPercVec
plotdataf$botPercVec=botPercVec

plotdf<-data.frame(meanVec,topPercVec,botPercVec,seq(1:18),t(PermDif[1001,]))

library(RcmdrPlugin.KMggplot2)

# keller kode
ggplot(plotdf)+geom_stepribbon(aes(x=seq.1.18.*10,ymin=botPercVec*100,ymax=topPercVec*100),fill='gray80')+geom_step(aes(x=seq.1.18.*10,y=X1001*100),color='blue',size=2)+theme_classic(base_size = 30)+xlab("Angular Distance (degrees)")+ylab('Percentage Difference')

p<-ggplot(plotdataf,aes(x=seq.1..18.,y=o_disthist...y_disthist*100))

p+geom_bar(stat='identity',color='black',aes(fill= ..x..),binwidth = 10)+xlab("Distance (Degrees)")+theme_classic(base_size = 26)+scale_x_continuous(limits=(c(0,190)))+scale_fill_gradientn("value",colors=c("blue","cyan","green","yellow","orange","red"))+ggtitle("\u2207PG Distance: Difference")+ylab('% of Propagations')+theme(plot.title= element_text(size=30, face="bold"), axis.title = element_text(size=30, face="bold",vjust=-1),axis.text = element_text(face="bold",size=30),legend.title=element_blank(),legend.text=element_text(size=20),legend.position=c(1.08,.41),plot.margin=margin(b=.1,t=.1,l=.1,r=2.3, unit='cm'))+ylab('count')+ylab('% of Propagations')+geom_ribbon(aes(x=seq.1..18.,ymin=botPercVec*100,ymax=topPercVec*100),fill='gray80',alpha=.5)
# saved out at 650x650

### aaaaand permuted task vs rest dif

```

```{r}
library(scales)
# read in discretized cross subj histograms (linear, modes)
o_disthist<-t(read.csv('Y:/results/PWs/old_subs_AngDistHist_modedOverTRs.csv'))
y_disthist<-t(read.csv('Y:/results/PWs/young_subs_AngDistHist_modedOverTRs.csv'))

# normalize to total numbers
o_disthist<-o_disthist/sum(o_disthist)
y_disthist<-y_disthist/sum(y_disthist)

difHist=o_disthist-y_disthist

barplot(t(o_disthist),ylim=c(0,0.2),main = 'Old r.s. OpFl Directionality',xlab='0-180')

barplot(t(y_disthist),ylim=c(0,0.2),main = 'Young OpFl Directionality',xlab='0-180')

barplot(t(difHist),main='Difference in OpFl Directionality',xlab='0-180')

# correct to be degrees rather than histogram bin index
plotdataf<-data.frame(seq(10,170,10),y_disthist)
# correct to be degrees rather than histogram bin index
colnames(plotdataf)<-c('index','y_disthist')

p<-ggplot(plotdataf,aes(x=index,y=y_disthist))
p+geom_bar(stat='identity',color='black',aes(fill= ..x..),binwidth = 10)+xlab("Distance (Degrees)")+theme_classic(base_size = 23)+scale_x_continuous(limits=(c(5,180)))+scale_fill_gradientn("value",colors=c("blue","cyan","green","yellow","orange","red"),guide=guide_colorbar(ticks = F))+ggtitle("Angular Distance: 8-14 Modes")+theme(legend.title=element_blank(),legend.text=element_text(size=20),legend.position=c(1.08,.41),plot.margin=margin(b=.1,t=.1,l=.1,r=2.3, unit='cm'))+ylab('count')

# correct to be degrees rather than histogram bin index
plotdataf<-data.frame(seq(10,170,10),o_disthist)
# correct to be degrees rather than histogram bin index
colnames(plotdataf)<-c('index','o_disthist')

p<-ggplot(plotdataf,aes(x=index,y=o_disthist))
p+geom_bar(stat='identity',color='black',aes(fill= ..x..),binwidth = 10)+xlab("Distance (Degrees)")+theme_classic(base_size = 23)+scale_x_continuous(limits=(c(5,180)))+scale_fill_gradientn("value",colors=c("blue","cyan","green","yellow","orange","red"),guide=guide_colorbar(ticks = F))+ggtitle("Angular Distance: 17-21 Modes")+theme(legend.title=element_blank(),legend.text=element_text(size=20),legend.position=c(1.08,.41),plot.margin=margin(b=.1,t=.1,l=.1,r=2.3, unit='cm'))+ylab('count')

# dif
# correct to be degrees rather than histogram bin index
plotdataf<-data.frame(seq(10,170,10),o_disthist-y_disthist)
# correct to be degrees rather than histogram bin index
colnames(plotdataf)<-c('index','dif_disthist')

p<-ggplot(plotdataf,aes(x=index,y=dif_disthist))
p+geom_bar(stat='identity',color='black',aes(fill= ..x..),binwidth = 10)+xlab("Distance (Degrees)")+theme_classic(base_size = 23)+scale_x_continuous(limits=(c(5,180)))+scale_fill_gradientn("value",colors=c("blue","cyan","green","yellow","orange","red"),guide=guide_colorbar(ticks = F))+ggtitle("Angular Distance: Modal Difference")+theme(legend.title=element_blank(),legend.text=element_text(size=20),legend.position=c(1.08,.41),plot.margin=margin(b=.1,t=.1,l=.1,r=2.3, unit='cm'))+ylab('count')+scale_y_continuous(labels = percent_format(accuracy = 1))
```

```{r}
library(scales)
# quick checkup on how BuProp from hists (and rs_subs.csv) maps onto bimodality
BuProp=t(read.csv('Y:/results/PWs/rs_subsBuProp.csv'))
Subjs=read.delim('Y:/PWs/rs_subs.csv',sep=' ')
BuPropdf<-data.frame(BuProp,Subjs)
colnames(BuPropdf)<-c('BuProp','SubjID')
BuMerge<-merge(BuPropdf,masterdf,by='SubjID')

#plotting
BuDs<-ggplot(BuMerge,aes(x=Ds,y=1-BuProp))+geom_point(size=3,alpha=.5)+theme_classic(base_size=28)+geom_smooth(method='lm',color='black')
BuDs+xlab('Dip Statistics')+ylab('Top-Down')+scale_y_continuous(labels = percent_format(accuracy = 1))+scale_x_continuous(breaks=c(.002,.006,.01))
```

```{r}
#### read in discritized cross subj histograms (linear)
# PGG
disthist<-t(read.csv('Y:/results/PWs/rs_subs_AngDistHist.csv'))
disthistModes<-t(read.csv('Y:/results/PWs/rs_subs_AngDistHist_modedOverTRs.csv'))

# CG
curv_disthist<-t(read.csv('Y:/results/PWs/rs_subs_AngDistHist_curv.csv'))

# PGG in cmatched rs, PGG in carit
rs_disthist<-t(read.csv('Y:/results/PWs/RS_cmatch_subs_AngDistHist.csv'))
c_disthist<-t(read.csv('Y:/results/PWs/c_cmatch_subs_AngDistHist.csv'))
rs_disthistModes<-t(read.csv('Y:/results/PWs/RS_cmatch_subs_AngDistHist_modedOverTRs.csv'))
c_disthistModes<-t(read.csv('Y:/results/PWs/c_cmatch_subs_AngDistHist_modedOverTRs.csv'))

# normalize to total numbers
rs_disthist<-rs_disthist/sum(rs_disthist)
c_disthist<-c_disthist/sum(c_disthist)
disthist<-disthist/sum(disthist)
disthistModes<-disthistModes/sum(disthistModes)
curv_disthist<-curv_disthist/sum(curv_disthist)
rs_disthistModes<-rs_disthistModes/sum(rs_disthistModes)
c_disthistModes<-c_disthistModes/sum(c_disthistModes)

difHist=c_disthist-rs_disthist
difHistModes=c_disthistModes-rs_disthistModes

# uncorrected plot of PGG directionality: percentage of OpFl vectors that occupy each angular distance bin across time and subjects (0-18 bins)

barplot(t(disthist),ylim=c(0,0.07),main = 'OpFl Directionality - PGG',xlab='0-180')

# uncorrected plot of CG directionality: percentage of OpFl vectors that occupy each angular distance bin across time and subjects (0-18 bins) for the curvature gradient

barplot(t(curv_disthist),ylim=c(0.05,0.06),main = 'OpFl Directionality - CG',xlab='0-180')

# 
barplot(t(rs_disthist),ylim=c(0,0.07),main = 'Resting State OpFl Directionality - PGG/subs w/ adequate Carit TRs',xlab='0-180')

barplot(t(c_disthist),ylim=c(0,0.07),main = 'Carit OpFl Directionality',xlab='0-180')

### letting these 4 go inert for now - dif hist and modes
#barplot(t(difHist),main='Difference in OpFl Directionality',xlab='0-180')
#barplot(t(disthistModes),ylim=c(0,.2),main='Facial Modes OpFl Directionality',xlab='0-180')
#barplot(t(rs_disthistModes),ylim=c(0,.2),main='Facial Modes OpFl Directionality: rs',xlab='0-180')
#barplot(t(c_disthistModes),ylim=c(0,.2),main='Facial Modes OpFl Directionality: carit',xlab='0-180')
#barplot(t(difHistModes),main='Facial Modes Difference in OpFl Directionality',xlab='0-180')

# just cutting it here for a break, next chunk continues w/ same code
```

```{r}

########### PGG Angular Distance over All TRs/Subjs - in bins
plotdataf<-data.frame(seq(1,18),disthist)
# correct to be degrees rather than histogram bin index
plotdataf$seq.1..18.<-plotdataf$seq.1..18.*10

p<-ggplot(plotdataf,aes(x=seq.1..18.,y=disthist*100))
p+geom_bar(stat='identity',color='black',aes(fill= ..x..),binwidth = 10)+xlab("Distance (Degrees)")+theme_classic(base_size = 26)+scale_x_continuous(limits=(c(0,190)))+scale_fill_gradientn("value",colors=c("blue","cyan","green","yellow","orange","red"))+ggtitle(paste0('\u2207PG Angular Distance over all TRs'))+theme(plot.title=element_text(vjust=-1),legend.title=element_blank(),legend.text=element_text(size=20),legend.position=c(1.05,.41),plot.margin=margin(b=.1,t=.1,l=.1,r=2, unit='cm'))+ylab('count')+ylab('% of Propagations')+theme(plot.title= element_text(size=30, face="bold"), axis.title = element_text(size=30, face="bold",vjust=-1),axis.text = element_text(face="bold",size=30),legend.title=element_blank(),legend.text=element_text(size=20),legend.position=c(1.08,.41),plot.margin=margin(b=.1,t=.1,l=.1,r=2.3, unit='cm'))+ylab('count')+ylab('% of Propagations')

# saved out at 750x750
```

```{r}
########## CG Angular Distance over all TRs/Subjs
plotdataf<-data.frame(seq(1,18),curv_disthist)
# correct to be degrees rather than histogram bin index
plotdataf$seq.1..18.<-plotdataf$seq.1..18.*10

p<-ggplot(plotdataf,aes(x=seq.1..18.,y=curv_disthist*100))
p+geom_bar(stat='identity',color='black',aes(fill= ..x..),binwidth = 10)+xlab("Distance (Degrees)")+theme_classic(base_size = 26)+scale_x_continuous(limits=(c(0,190)))+scale_fill_gradientn("value",colors=c("blue","cyan","green","yellow","orange","red"))+ggtitle("\u2207Curv. Angular Distance over all TRs")+theme(legend.title=element_blank(),legend.text=element_text(size=20),legend.position=c(1.05,.41),plot.margin=margin(b=.1,t=.1,l=.1,r=2, unit='cm'),plot.title = element_text(size=29,hjust=.23))+ylab('count')+ylab('% of Propagations')+theme(plot.title= element_text(size=30, face="bold"), axis.title = element_text(size=30, face="bold",vjust=-1),axis.text = element_text(face="bold",size=30),legend.title=element_blank(),legend.text=element_text(size=20),legend.position=c(1.08,.41),plot.margin=margin(b=.1,t=.1,l=.1,r=2.3, unit='cm'))+ylab('count')+ylab('% of Propagations')

# saved out at 750x750
```



```{r}
library(visreg)
# convert to prop TD
BuMerge$TDProp=1-BuMerge$BuProp

# dev analyses
devMod<-gam(TDProp~s(interview_age,k=4)+FD+sex+RemainingTRs,data=BuMerge)
ndevMod<-gam(TDProp~FD+sex+RemainingTRs,data=BuMerge)
anovaRes<-anova.gam(devMod,ndevMod,test='Chisq')
anovaRes$`Pr(>Chi)`
# difference in adjusted r2
summary(devMod)$r.sq-summary(ndevMod)$r.sq


# get residuals of model for plotting
TDProp_lm<-lm(TDProp~FD+sex+RemainingTRs,data=BuMerge)
BuMerge$TDProp_resid<-TDProp_lm$residuals+mean(BuMerge$TDProp)

ggplot(BuMerge,aes(x=(interview_age)/12,y=TDProp_resid)) + geom_smooth(method = 'gam', formula = y~s(x,k=4), colour=('black'), fill = "#ed2224", alpha = .4)+ggtitle('Whole-Cortex') + geom_point(size=3,alpha=.5) + xlab("Age (Years)") +ylab("Top-Down Propagations") + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), panel.background = element_blank()) + theme(axis.line.x = element_line(colour = 'black', size = 2), axis.line.y = element_line(colour = 'black', size = 2), axis.ticks.length = unit(.25, "cm"), plot.title=element_text(size=30), axis.text = element_text(face="bold",size=30), axis.title = element_text(size=30, face="bold"), axis.title.y = element_text(margin = margin(t = 0, r = 47, b = 0, l = 0))) +scale_y_continuous(labels = percent_format(accuracy = 1))

# saved at 750x750

# aaaand combat chunk on it
library(devtools)
#install_github("jfortin1/neuroCombatData")
#install_github("jfortin1/neuroCombat_Rpackage")

library(neuroCombat)

# get site info
BuMerge$d_site<-droplevels(as.factor(BuMerge$site))
batch <- BuMerge$d_site
BuMerge.toharmonize <- BuMerge[,c("TDProp","FD")]
mod <- model.matrix(~BuMerge$interview_age+BuMerge$sex)
dat <- t(BuMerge.toharmonize)
hcpd.data.combat <- neuroCombat(dat=dat,mod=mod,batch=batch,eb=FALSE)
dat.harmonized<-data.frame(t(hcpd.data.combat$dat.combat))

BuMerge$harmTDProp<-dat.harmonized$TDProp
BuMerge$harmFD<-dat.harmonized$FD

visreg(gam(harmTDProp~s(interview_age,k=4)+harmFD+sex,data=BuMerge))

# get residuals of model for plotting
TDProp_lm<-lm(harmTDProp~harmFD+sex,data=BuMerge)
BuMerge$TDProp_resid<-TDProp_lm$residuals+mean(BuMerge$TDProp)

ggplot(BuMerge,aes(x=(interview_age)/12,y=TDProp_resid)) + geom_smooth(method = 'gam', formula = y~s(x,k=4), colour=('black'), fill = "#ed2224", alpha = .4) + geom_point(size=3,alpha=.5) + xlab("Age") +ylab("Top-Down Propagations:\n ComBat Harmonized") + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), panel.background = element_blank()) + theme(axis.line.x = element_line(colour = 'black', size = 2), axis.line.y = element_line(colour = 'black', size = 2), axis.ticks.length = unit(.25, "cm"), axis.text = element_text(face="bold",size=30), axis.title = element_text(size=30, face="bold"), axis.title.y = element_text(margin = margin(t = 0, r = 47, b = 0, l = 0),vjust=-4)) +scale_y_continuous(labels = percent_format(accuracy = 1))

#### show DMN Segreg

# dev analyses controlling for DMN seg
devMod_DMSC<-gam(TDProp~s(interview_age,k=4)+FD+sex+RemainingTRs+DMNseg,data=BuMerge)
ndevMod_DMSC<-gam(TDProp~FD+sex+RemainingTRs+DMNseg,data=BuMerge)
anovaRes<-anova.gam(devMod_DMSC,ndevMod_DMSC,test='Chisq')
anovaRes$`Pr(>Chi)`


# get residuals of model for plotting
TDProp_lm<-lm(TDProp~FD+sex+RemainingTRs+DMNseg,data=BuMerge)
BuMerge$TDProp_resid<-TDProp_lm$residuals+mean(BuMerge$TDProp)

ggplot(BuMerge,aes(x=(interview_age)/12,y=TDProp_resid)) + geom_smooth(method = 'gam', formula = y~s(x,k=4), colour=('black'), fill = "#ed2224", alpha = .4) + geom_point(size=3,alpha=.5) + xlab("Age") +ylab("Top-Down Propagations:\n Controlling for DMN Seg.") + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), panel.background = element_blank()) + theme(axis.line.x = element_line(colour = 'black', size = 2), axis.line.y = element_line(colour = 'black', size = 2), axis.ticks.length = unit(.25, "cm"), axis.text = element_text(face="bold",size=30), axis.title = element_text(size=30, face="bold"), axis.title.y = element_text(margin = margin(t = 0, r = 47, b = 0, l = 0),vjust=-4)) +scale_y_continuous(labels = percent_format(accuracy = 1))

# DMN model
summary(gam(DMNseg~s(interview_age,k=4)+FD+sex+RemainingTRs+TDProp,data=BuMerge))
# and plotting dmn seg directly
DMN_lm<-lm(DMNseg~FD+sex+RemainingTRs+TDProp,data=BuMerge)
BuMerge$DMN_lm_resid<-DMN_lm$residuals+mean(BuMerge$DMNseg)

ggplot(BuMerge,aes(x=(interview_age)/12,y=DMN_lm_resid)) + geom_smooth(method = 'gam', formula = y~s(x,k=4), colour=('black'), fill = "#ed2224", alpha = .4) + geom_point(size=3,alpha=.5) + xlab("Age") +ylab("DMN External \n Connectivity") + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), panel.background = element_blank()) + theme(axis.line.x = element_line(colour = 'black', size = 2), axis.line.y = element_line(colour = 'black', size = 2), axis.ticks.length = unit(.25, "cm"), axis.text = element_text(face="bold",size=30), axis.title = element_text(size=30, face="bold"), axis.title.y = element_text(margin = margin(t = 0, r = 47, b = 0, l = 0),vjust=-4))
```

```{r}
write.table(masterdf$SubjID,'~/G600_TRs.txt',quote = F,col.names = F,row.names = F)
```



```{r}
# read in discretized cross subj histograms (circular)
disthist<-t(read.csv('Y:/PWs/rs_subs_AngDistHist360.csv',header=F))
disthistModes<-t(read.csv('Y:/PWs/rs_subs_AngDistHist360_modedOverTRs.csv',header=F))

plotdf<-data.frame(disthist)
plotdf$index<-seq(1:36)

# Make the plot
p <- ggplot(plotdf, aes(x = as.factor(index), # x-axis factor label
					
					# y-axis numerical parameter
					y = round(as.numeric(disthist)))) +	

# the bar height will represent
# the actual value of the data
geom_bar(stat = "identity",color='black',
		aes(fill=index)) + # define bar color
# define the polar coordinate
coord_polar(start = 3.1416)


# plot
p+theme_minimal(base_size=24)+scale_fill_gradientn("index",colors=c("red","orange","yellow","green","cyan","blue","cyan","green","yellow","orange","red"),breaks=c(1,18,36),labels=c(expression(paste('-',pi)),0,expression(paste('',pi))))+theme(panel.grid.major=element_line(colour="black"),panel.grid.minor=element_line(colour="black"),legend.position = 'bottom',legend.key.width = unit(2,'cm'),legend.title = element_blank(),axis.text = element_blank(),axis.title.y=element_blank())+xlab('Distance (Radians)')+ylim(c(-100000000,150000000))

##### same for modes
plotdf<-data.frame(disthistModes[1,])
plotdf$index<-seq(1:36)

# Make the plot
p <- ggplot(plotdf, aes(x = as.factor(index), # x-axis factor label
					
					# y-axis numerical parameter
					y = round(as.numeric(disthistModes.1...)))) +	

# the bar height will represent
# the actual value of the data
geom_bar(stat = "identity",color='black',
		aes(fill=index)) + # define bar color
# define the polar coordinate
coord_polar(start = 3.1416)


# plot
p+theme_minimal(base_size=24)+scale_fill_gradientn("index",colors=c("red","orange","yellow","green","cyan","blue","cyan","green","yellow","orange","red"),breaks=c(1,18,36),labels=c(expression(paste('-',pi)),0,expression(paste('',pi))))+theme(panel.grid.major=element_line(colour="black"),panel.grid.minor=element_line(colour="black"),legend.position = 'bottom',legend.key.width = unit(2,'cm'),legend.title = element_blank(),axis.text = element_blank(),axis.title.y=element_blank())+xlab('Distance (Radians)')+ylim(c(-10000,223000))


```

```{r}
# read in discretized cross subj histograms (circular) - Young/Old
disthist<-t(read.csv('Y:/PWs/young_subs_AngDistHist360.csv',header=F))
disthistModes<-t(read.csv('Y:/PWs/young_subs_AngDistHist360_modedOverTRs.csv',header=F))

plotdf<-data.frame(disthist)
plotdf$index<-seq(1:36)

# Make the plot
p <- ggplot(plotdf, aes(x = as.factor(index), # x-axis factor label
					
					# y-axis numerical parameter
					y = round(as.numeric(disthist)))) +	

# the bar height will represent
# the actual value of the data
geom_bar(stat = "identity",color='black',
		aes(fill=index)) + # define bar color
# define the polar coordinate
coord_polar(start = 3.1416)


# plot
p+theme_minimal(base_size=24)+scale_fill_gradientn("index",colors=c("red","orange","yellow","green","cyan","blue","cyan","green","yellow","orange","red"),breaks=c(1,18,36),labels=c(expression(paste('-',pi)),0,expression(paste('',pi))))+theme(panel.grid.major=element_line(colour="black"),panel.grid.minor=element_line(colour="black"),legend.position = 'bottom',legend.key.width = unit(2,'cm'),legend.title = element_blank(),axis.text = element_blank(),axis.title.y=element_blank())+xlab('Distance (Radians)')+ylim(c(-40000000,45000000))

##### same for modes
plotdf<-data.frame(disthistModes[1,])
plotdf$index<-seq(1:36)

# Make the plot
p <- ggplot(plotdf, aes(x = as.factor(index), # x-axis factor label
					
					# y-axis numerical parameter
					y = round(as.numeric(disthistModes.1...)))) +	

# the bar height will represent
# the actual value of the data
geom_bar(stat = "identity",color='black',
		aes(fill=index)) + # define bar color
# define the polar coordinate
coord_polar(start = 3.1416)


# plot
p+theme_minimal(base_size=24)+scale_fill_gradientn("index",colors=c("red","orange","yellow","green","cyan","blue","cyan","green","yellow","orange","red"),breaks=c(1,18,36),labels=c(expression(paste('-',pi)),0,expression(paste('',pi))))+theme(panel.grid.major=element_line(colour="black"),panel.grid.minor=element_line(colour="black"),legend.position = 'bottom',legend.key.width = unit(2,'cm'),legend.title = element_blank(),axis.text = element_blank(),axis.title.y=element_blank())+xlab('Distance (Radians)')+ylim(c(-40000,74000))

#####################
#### and old folk
#####################

disthistO<-t(read.csv('Y:/PWs/old_subs_AngDistHist360.csv',header=F))
disthistModesO<-t(read.csv('Y:/PWs/old_subs_AngDistHist360_modedOverTRs.csv',header=F))
plotdf<-data.frame(disthistO)
plotdf$index<-seq(1:36)

# Make the plot
p <- ggplot(plotdf, aes(x = as.factor(index), # x-axis factor label
					
					# y-axis numerical parameter
					y = round(as.numeric(disthistO)))) +	

# the bar height will represent
# the actual value of the data
geom_bar(stat = "identity",color='black',
		aes(fill=index)) + # define bar color
# define the polar coordinate
coord_polar(start = 3.1416)


# plot
p+theme_minimal(base_size=24)+scale_fill_gradientn("index",colors=c("red","orange","yellow","green","cyan","blue","cyan","green","yellow","orange","red"),breaks=c(1,18,36),labels=c(expression(paste('-',pi)),0,expression(paste('',pi))))+theme(panel.grid.major=element_line(colour="black"),panel.grid.minor=element_line(colour="black"),legend.position = 'bottom',legend.key.width = unit(2,'cm'),legend.title = element_blank(),axis.text = element_blank(),axis.title.y=element_blank())+xlab('Distance (Radians)')+ylim(c(-49000000,57000000))

##### same for modes
plotdf<-data.frame(disthistModesO[1,])
plotdf$index<-seq(1:36)

# Make the plot
p <- ggplot(plotdf, aes(x = as.factor(index), # x-axis factor label
					
					# y-axis numerical parameter
					y = round(as.numeric(disthistModesO.1...)))) +	

# the bar height will represent
# the actual value of the data
geom_bar(stat = "identity",color='black',
		aes(fill=index)) + # define bar color
# define the polar coordinate
coord_polar(start = 3.1416)
p+theme_minimal(base_size=24)+scale_fill_gradientn("index",colors=c("red","orange","yellow","green","cyan","blue","cyan","green","yellow","orange","red"),breaks=c(1,18,36),labels=c(expression(paste('-',pi)),0,expression(paste('',pi))))+theme(panel.grid.major=element_line(colour="black"),panel.grid.minor=element_line(colour="black"),legend.position = 'bottom',legend.key.width = unit(2,'cm'),legend.title = element_blank(),axis.text = element_blank(),axis.title.y=element_blank())+xlab('Distance (Radians)')+ylim(c(-40000,78000))


# convert to proporitons for meaningful difference calculation
disthistprop=disthist/sum(disthist)
disthistpropO=disthistO/sum(disthist0)
# same for modes
disthistpropM=disthistModes/sum(disthistModes)
disthistpropMO=disthistModesO/sum(disthistModes0)

# difference
plotdf$dif<-disthistpropO-disthistprop
plotdf$modedif<-disthistpropMO[1,]-disthistpropM[1,]

# Make the plot
p <- ggplot(plotdf, aes(x = as.factor(index), # x-axis factor label
					
					# y-axis numerical parameter
					y = as.numeric(dif))) +	

# the bar height will represent
# the actual value of the data
geom_bar(stat = "identity",color='black',
		aes(fill=index)) + # define bar color
# define the polar coordinate
coord_polar(start = 3.1416)


# plot
p+theme_minimal(base_size=24)+scale_fill_gradientn("index",colors=c("red","orange","yellow","green","cyan","blue","cyan","green","yellow","orange","red"),breaks=c(1,18,36),labels=c(expression(paste('-',pi)),0,expression(paste('',pi))))+theme(panel.grid.major=element_line(colour="black"),panel.grid.minor=element_line(colour="black"),legend.position = 'bottom',legend.key.width = unit(2,'cm'),legend.title = element_blank(),axis.text = element_blank(),axis.title.y=element_blank())+xlab('Distance (Radians)')+ylim(c(-.0008,.0008))


# Make the plot
p <- ggplot(plotdf, aes(x = as.factor(index), # x-axis factor label
					
					# y-axis numerical parameter
					y = as.numeric(modedif))) +	

# the bar height will represent
# the actual value of the data
geom_bar(stat = "identity",color='black',
		aes(fill=index)) + # define bar color
# define the polar coordinate
coord_polar(start = 3.1416)


# plot
p+theme_minimal(base_size=24)+scale_fill_gradientn("index",colors=c("red","orange","yellow","green","cyan","blue","cyan","green","yellow","orange","red"),breaks=c(1,18,36),labels=c(expression(paste('-',pi)),0,expression(paste('',pi))))+theme(panel.grid.major=element_line(colour="black"),panel.grid.minor=element_line(colour="black"),legend.position = 'bottom',legend.key.width = unit(2,'cm'),legend.title = element_blank(),axis.text = element_blank(),axis.title.y=element_blank())+xlab('Distance (Radians)')+ylim(c(-.0002,.0002))

```

```{r}
plotdf<-data.frame(dif)
plotdf$index<-seq(1:36)

# Make the plot
p <- ggplot(plotdf, aes(x = as.factor(index), # x-axis factor label
					
					# y-axis numerical parameter
					y = round(as.numeric(disthistModesO.1...)))) +	

# the bar height will represent
# the actual value of the data
geom_bar(stat = "identity",color='black',
		aes(fill=index)) + # define bar color
# define the polar coordinate
coord_polar(start = 3.1416)
p+theme_minimal(base_size=24)+scale_fill_gradientn("index",colors=c("red","orange","yellow","green","cyan","blue","cyan","green","yellow","orange","red"),breaks=c(1,18,36),labels=c(expression(paste('-',pi)),0,expression(paste('',pi))))+theme(panel.grid.major=element_line(colour="black"),panel.grid.minor=element_line(colour="black"),legend.position = 'bottom',legend.key.width = unit(2,'cm'),legend.title = element_blank(),axis.text = element_blank(),axis.title.y=element_blank())+xlab('Distance (Radians)')+ylim(c(-40000,78000))

```


```{r}
prop=read.csv('Y:/data/meanProp.csv')
PropMasked=c(prop$TDP_vL[1:4589],prop$TDP_vR[1:4595])

PGGdata_L=read.csv('Y:/data/MeanMeanPGGDif_L.csv')
PGGdata_R=read.csv('Y:/data/MeanMeanPGGDif_R.csv')
PGGcombined=c(melt(PGGdata_L)$value,melt(PGGdata_R)$value)

# transform -6 to 6 radians to parallel vs. antiparallel (0 to pi)
PGGcombined=abs(PGGcombined)
# recenter on pi
PGGcombined=PGGcombined-pi
# abs it to reflect across pi
PGGcombined=abs(PGGcombined)
# mult by -1 to restore directionality
PGGcombined=PGGcombined*-1
# re-translate to restore -pi from above
PGGcombined=PGGcombined+pi

# load in pg values
PGFaceVals_L=read.csv('Y:/PWs/scripts/PGFaceVals_L.csv')
PGFaceVals_R=read.csv('Y:/Pws/scripts/PGFaceVals_R.csv')
PGFaceVals=c(melt(PGFaceVals_L)$value,melt(PGFaceVals_R)$value)

plotdf<-data.frame(PGGcombined,PropMasked,PGFaceVals)

ggplot(plotdf,aes(x=PGGcombined,y=PropMasked))+geom_point(size=2,alpha=.3)+theme_classic()+xlab('Primary Direction of Face')+ylab('% Top-Down')+ylim(.4,.6)+geom_smooth()

ggplot(plotdf,aes(x=PGGcombined,y=PropMasked,color=PGFaceVals))+geom_point(size=2,alpha=.3)+theme_classic()+xlab('Primary Direction of Face')+ylab('% Top-Down')+scale_color_continuous(type='viridis')+ylim(.4,.6)+geom_smooth()

ggplot(plotdf[plotdf$PGFaceVals< -2.5,],aes(x=PGGcombined,y=PropMasked))+geom_point(alpha=.1)+theme_classic()+xlab('Primary Direction of Face')+ylab('% Top-Down')+ylim(.4,.6)+geom_smooth()

ggplot(plotdf[plotdf$PGFaceVals > 2.5,],aes(x=PGGcombined,y=PropMasked))+geom_point(alpha=.1)+theme_classic()+xlab('Primary Direction of Face')+ylab('% Top-Down')+ylim(.4,.6)+geom_smooth()

summary(lm(PropMasked~PGGcombined*PGFaceVals))
```
