---
title: "Group_level"
output: html_document
---

```{r}
library(shapes)
library(ggplot2)
library(mgcv)
```

```{r}
# load in subj list
subjList=read.delim('Y:/PWs/hcpd_subj_list.txt')

# load in ages
demo=read.csv('Y:/PWs/hcpd_demographics.csv')
# convert to used naming convention
demo$SubjID<-gsub('HCD','sub-',demo$src_subject_id)

# load in FD
FD_TRs=read.csv('Y:/PWs/Subj_FD_RemTRs.csv')
colnames(FD_TRs)[1]<-'SubjID'
colnames(FD_TRs)[2]<-'FD'
colnames(FD_TRs)[3]<-'RemainingTRs'

# merge by subjID
mergeddf<-merge(demo,FD_TRs,by='SubjID')

# initialize D
Ds=rep(0,dim(subjList)[1])
Ps=rep(0,dim(subjList)[1])
remTRs=rep(0,dim(subjList)[1])

# subjvec to run in parallel for even more confidence in merging
Subjvec=rep(0,dim(subjList)[1])

# initialize shape matrix
shapeMat=array(dim=c(24,2,dim(subjList)[1]))
shapeMatAbs=array(dim=c(24,2,dim(subjList)[1]))

# load in D and shapes iteratively
for (s in 1:dim(subjList)[1]){
    subj=subjList[s,1]
    ResFp=paste0('Y:/results/PWs/Proced/',subj,'/')
    # if output exists
    if (file.exists(paste0(ResFp,subj,'_gShapeMatrix.rds'))) {
      # load in shapemat
      shapemat=readRDS(paste0(ResFp,subj,'_gShapeMatrix.rds'))
      # scale it
      divisorPt2=24/(max(shapemat[,2])-min(shapemat[,2]))
      shapeMat[,1,s]=shapemat[,1]
      shapeMat[,2,s]=shapemat[,2]*divisorPt2
      # load in shapemat abs
      #shapematAbs=readRDS(paste0(ResFp,subj,'_AbsShapeMatrix.rds'))
      # scale it
      #divisorPt1a=max(shapematAbs[,2])
      #divisorPt2a=20/divisorPt1a
      #shapeMatAbs[,1,s]=shapematAbs[,1]
      #shapeMatAbs[,2,s]=shapematAbs[,2]*divisorPt2a
      # load in dip test
      dipstat=readRDS(paste0(ResFp,subj,'_gDipTest.rds'))
      Ds[s]=dipstat$statistic
      Ps[s]=dipstat$p.value
      # and to record same order of subj loading and prevent funny biz
      Subjvec[s]=subj
      print(s)
      # and remaining TRs
      remTRs[s]=mergeddf$RemainingTRs[mergeddf$SubjID==subj]
    }
}

# merge populated vecs
popDf=data.frame(Subjvec,Ds,Ps,remTRs)
colnames(popDf)[1]<-'SubjID'

# remaining TRs thresh
inclusionVec<-popDf$remTRs>600
includedSubjsvec<-popDf$SubjID[inclusionVec]
popDfThresh=popDf[popDf$remTRs>600,]
ThreshShapeMat<-shapeMat[,,inclusionVec]

masterdf=merge(mergeddf,popDfThresh,by='SubjID')

```
```{r}
# make list of old subjs vs younger
low_tertile_age=quantile(masterdf$interview_age,.33)
high_tertile_age=quantile(masterdf$interview_age,.66)

# youngins
youngins=masterdf$SubjID[masterdf$interview_age<low_tertile_age]
write.table(youngins,'Y:/PWs/young_subs.csv')
#geezers
geezers=masterdf$SubjID[masterdf$interview_age>high_tertile_age]
write.table(geezers,'Y:/PWs/old_subs.csv')
```

```{r}
# read in discretized cross subj histograms (linear)
o_disthist<-t(read.csv('Y:/results/PWs/old_subs_AngDistHist.csv'))
y_disthist<-t(read.csv('Y:/results/PWs/young_subs_AngDistHist.csv'))

# normalize to total numbers
o_disthist<-o_disthist/sum(o_disthist)
y_disthist<-y_disthist/sum(y_disthist)

difHist=o_disthist-y_disthist

barplot(t(o_disthist),ylim=c(0,0.07),main = 'Old r.s. OpFl Directionality',xlab='0-180')

barplot(t(y_disthist),ylim=c(0,0.07),main = 'Young OpFl Directionality',xlab='0-180')

barplot(t(difHist),main='Difference in OpFl Directionality',xlab='0-180')
```

```{r}
# read in discretized cross subj histograms (linear, modes)
o_disthist<-t(read.csv('Y:/results/PWs/old_subs_AngDistHist_modedOverTRs.csv'))
y_disthist<-t(read.csv('Y:/results/PWs/young_subs_AngDistHist_modedOverTRs.csv'))

# normalize to total numbers
o_disthist<-o_disthist/sum(o_disthist)
y_disthist<-y_disthist/sum(y_disthist)

difHist=o_disthist-y_disthist

barplot(t(o_disthist),ylim=c(0,0.2),main = 'Old r.s. OpFl Directionality',xlab='0-180')

barplot(t(y_disthist),ylim=c(0,0.2),main = 'Young OpFl Directionality',xlab='0-180')

barplot(t(difHist),main='Difference in OpFl Directionality',xlab='0-180')
```


```{r}
### make subject lists for RS (388), RS w/ good _C, and good _C

###### 388
rs_subs<-masterdf$SubjID
#print
write.table(rs_subs,'Y:/PWs/rs_subs.csv')

#### RS_C matched: rope in a bunch of goblyguk just for equivalence with facewise_t
# load in FD
FD_TRs=read.csv('Y:/PWs/Subj_FD_RemTRs.csv')
colnames(FD_TRs)[1]<-'SubjID'
colnames(FD_TRs)[2]<-'FD'
colnames(FD_TRs)[3]<-'RemainingTRs'
# FD for carit runs
FD_TRs_c=read.csv('Y:/PWs/Subj_FD_RemTRs_c.csv')
colnames(FD_TRs_c)[1]<-'SubjID'
colnames(FD_TRs_c)[2]<-'FDc'
colnames(FD_TRs_c)[3]<-'RemainingTRsc'
# merge by subjID
mergeddf<-merge(demo,FD_TRs,by='SubjID')
mergeddf<-merge(mergeddf,FD_TRs_c,by='SubjID')
# exclude subjects with less than 600 TRs remaining (in rest)
inclusionVec<-mergeddf$RemainingTRs>600
# include NAs in the exclusion
inclusionVec[is.na(inclusionVec)==TRUE]=FALSE
# subset the master df accordingly
mergeddf<-mergeddf[inclusionVec,]
# get count of remaining subjects
remainingSubjs=dim(mergeddf)[1]
print(remainingSubjs)
# exclude subjects with less than 300 TRs remaining (in carit)
inclusionVec<-mergeddf$RemainingTRsc>300
# include NAs in the exclusion
inclusionVec[is.na(inclusionVec)==TRUE]=FALSE
# subset the master df accordingly
df<-mergeddf[inclusionVec,]
# get count of remaining subjects
remainingSubjs=dim(df)[1]
print(remainingSubjs)
# extract subjs
rs_cmatch_subjs<-df$SubjID
# print
write.table(rs_cmatch_subjs,'Y:/PWs/rs_cmatch_subs.csv')

# _C: will need FP alteration in .m, but is from same subjects

```

```{r}
# quick checkup on how BuProp from hists (and rs_subs.csv) maps onto bimodality
BuProp=t(read.csv('Y:/results/PWs/rs_subsBuProp.csv'))
Subjs=read.delim('Y:/PWs/rs_subs.csv',sep=' ')
BuPropdf<-data.frame(BuProp,Subjs)
colnames(BuPropdf)<-c('BuProp','SubjID')
BuMerge<-merge(BuPropdf,masterdf,by='SubjID')
```

```{r}
# read in discretized cross subj histograms (linear)
disthist<-t(read.csv('Y:/results/PWs/rs_subs_AngDistHist.csv'))
disthistModes<-t(read.csv('Y:/results/PWs/rs_subs_AngDistHist_modedOverTRs.csv'))
rs_disthist<-t(read.csv('Y:/results/PWs/RS_cmatch_subs_AngDistHist.csv'))
c_disthist<-t(read.csv('Y:/results/PWs/c_cmatch_subs_AngDistHist.csv'))
rs_disthistModes<-t(read.csv('Y:/results/PWs/RS_cmatch_subs_AngDistHist_modedOverTRs.csv'))
c_disthistModes<-t(read.csv('Y:/results/PWs/c_cmatch_subs_AngDistHist_modedOverTRs.csv'))

# normalize to total numbers
rs_disthist<-rs_disthist/sum(rs_disthist)
c_disthist<-c_disthist/sum(c_disthist)
disthist<-disthist/sum(disthist)
disthistModes<-disthistModes/sum(disthistModes)
rs_disthistModes<-rs_disthistModes/sum(rs_disthistModes)
c_disthistModes<-c_disthistModes/sum(c_disthistModes)

difHist=c_disthist-rs_disthist
difHistModes=c_disthistModes-rs_disthistModes

barplot(t(disthist),ylim=c(0,0.07),main = 'OpFl Directionality',xlab='0-180')

barplot(t(rs_disthist),ylim=c(0,0.07),main = 'Resting State OpFl Directionality',xlab='0-180')

barplot(t(c_disthist),ylim=c(0,0.07),main = 'Carit OpFl Directionality',xlab='0-180')

barplot(t(difHist),main='Difference in OpFl Directionality',xlab='0-180')

barplot(t(disthistModes),ylim=c(0,.2),main='Facial Modes OpFl Directionality',xlab='0-180')

barplot(t(rs_disthistModes),ylim=c(0,.2),main='Facial Modes OpFl Directionality: rs',xlab='0-180')

barplot(t(c_disthistModes),ylim=c(0,.2),main='Facial Modes OpFl Directionality: carit',xlab='0-180')


barplot(t(difHistModes),main='Facial Modes Difference in OpFl Directionality',xlab='0-180')



```

```{r}

# shape PCA
ShapeOut<-procGPA(ThreshShapeMat,reflect = F,scale=F)
shapepca(ShapeOut)

scoresdf<-data.frame(includedSubjsvec,ShapeOut$scores[,1],ShapeOut$scores[,2])
colnames(scoresdf)<-c('SubjID','PC1score','PC2score')

masterdf<-merge(masterdf,scoresdf,by='SubjID')

# plot some high PC examples
PCscores=sort(ShapeOut$scores[,1],index.return=T)
PCscoresneg=sort(-ShapeOut$scores[,2],index.return=T)

for (i in 1:30){
  index=PCscores$ix[i]
  #plot(binnedFaces[,1,index],binnedFaces[,2,index])
  plot(ThreshShapeMat[,1,index],ThreshShapeMat[,2,index],main=PCscores$x[i])
}

for (i in 1:30){
  index=PCscoresneg$ix[i]
  #plot(binnedFaces[,1,index],binnedFaces[,2,index])
  plot(ThreshShapeMat[,1,index],ThreshShapeMat[,2,index],main=PCscoresneg$x[i])
}

```

```{r}
library(visreg)
# dev analyses
summary(gam(BuProp~s(interview_age,k=4)+FD+sex,data=BuMerge))
```

```{r}
write.table(masterdf$SubjID,'~/G600_TRs.txt',quote = F,col.names = F,row.names = F)
```

```{r}
# pgg magnitude distributions
PGGmagL_s=read.csv('Y:/data/vsumL.csv')
PGGmagR_s=read.csv('Y:/data/vsumR.csv')
PGGmagL_h=read.csv('Y:/data/vHL.csv')
PGGmagR_h=read.csv('Y:/data/vHR.csv')

vecSumCombined=c(PGGmagL_s$vsumL,PGGmagR_s$vsumR)
vecHypCombined=c(PGGmagL_h$vHL,PGGmagR_h$vHR)

# bottom 1%
b1p=quantile(vecHypCombined,.1)
b1=vecHypCombined<b1p

# sep. back out for plotting
b1l=b1[1:4851]
b1r=b1[4852:length(b1)]

# writeout
write.csv(as.numeric(b1l),'Y:/dropbox/b1maskL.csv')
write.csv(as.numeric(b1r),'Y:/dropbox/b1maskR.csv')
```
```
